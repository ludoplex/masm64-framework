# MASM64 Framework CI/CD Pipeline
# Builds and tests the framework on Windows

name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  UASM_VERSION: "2.56.2"
  WDK_VERSION: "10.0.22621.0"

jobs:
  #---------------------------------------------------------------------------
  # Usermode builds - Console, GUI, DLL, Shellcode
  #---------------------------------------------------------------------------
  build-usermode:
    runs-on: windows-latest
    name: Build Usermode (${{ matrix.example }})
    
    strategy:
      fail-fast: false
      matrix:
        example: [hashcheck, colorpick, shellex, edrtest]
        include:
          - example: hashcheck
            type: console
          - example: colorpick
            type: gui
          - example: shellex
            type: dll
          - example: edrtest
            type: shellcode
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Visual Studio Build Tools
      uses: microsoft/setup-msbuild@v2
    
    - name: Build ${{ matrix.example }} (${{ matrix.type }})
      shell: cmd
      working-directory: examples/${{ matrix.example }}
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        if not exist bin mkdir bin
        if not exist obj mkdir obj
        call build.bat
    
    - name: Verify build output
      shell: pwsh
      working-directory: examples/${{ matrix.example }}
      run: |
        $outputs = Get-ChildItem -Path bin -File -ErrorAction SilentlyContinue
        if ($outputs) {
          Write-Host "Build outputs:"
          $outputs | ForEach-Object { Write-Host "  $($_.Name) - $($_.Length) bytes" }
        } else {
          Write-Error "No build outputs found!"
          exit 1
        }
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: example-${{ matrix.example }}
        path: examples/${{ matrix.example }}/bin/*
        retention-days: 7

  #---------------------------------------------------------------------------
  # Kernel mode builds - Drivers (requires WDK)
  #---------------------------------------------------------------------------
  build-driver:
    runs-on: windows-latest
    name: Build Driver (rawmouse)
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Visual Studio Build Tools
      uses: microsoft/setup-msbuild@v2
    
    - name: Install Windows Driver Kit
      shell: pwsh
      run: |
        Write-Host "Installing Windows Driver Kit..."
        
        # WDK requires matching SDK - check if present
        $sdkPath = "${env:ProgramFiles(x86)}\Windows Kits\10\Lib\${{ env.WDK_VERSION }}"
        if (-not (Test-Path $sdkPath)) {
          Write-Host "::warning::SDK version ${{ env.WDK_VERSION }} not found, WDK may not work"
        }
        
        # Download WDK
        $wdkUrl = "https://go.microsoft.com/fwlink/?linkid=2249371"
        $installerPath = "$env:TEMP\wdksetup.exe"
        
        Write-Host "Downloading WDK installer..."
        Invoke-WebRequest -Uri $wdkUrl -OutFile $installerPath -UseBasicParsing
        
        Write-Host "Installing WDK (this may take several minutes)..."
        $process = Start-Process -FilePath $installerPath -ArgumentList "/quiet", "/norestart" -Wait -PassThru
        
        if ($process.ExitCode -ne 0) {
          Write-Host "::warning::WDK installer exited with code $($process.ExitCode)"
        }
        
        # Verify installation
        $ntoskrnl = "${env:ProgramFiles(x86)}\Windows Kits\10\Lib\${{ env.WDK_VERSION }}\km\x64\ntoskrnl.lib"
        if (Test-Path $ntoskrnl) {
          Write-Host "WDK installed successfully"
        } else {
          Write-Host "::error::ntoskrnl.lib not found - WDK installation may have failed"
          exit 1
        }
    
    - name: Build rawmouse driver
      shell: cmd
      working-directory: examples/rawmouse
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        if not exist bin mkdir bin
        if not exist obj mkdir obj
        
        echo Assembling driver.asm...
        ml64 /c /nologo /Fo obj\driver.obj driver.asm
        if errorlevel 1 exit /b 1
        
        echo Linking rawmouse.sys...
        link /nologo /driver /entry:DriverEntry /subsystem:native ^
             /out:bin\rawmouse.sys ^
             obj\driver.obj ^
             "%ProgramFiles(x86)%\Windows Kits\10\Lib\${{ env.WDK_VERSION }}\km\x64\ntoskrnl.lib"
        if errorlevel 1 exit /b 1
        
        echo Driver built successfully
    
    - name: Verify driver output
      shell: pwsh
      run: |
        $driver = Get-Item "examples\rawmouse\bin\rawmouse.sys" -ErrorAction SilentlyContinue
        if ($driver) {
          Write-Host "Driver built: $($driver.Name) - $($driver.Length) bytes"
        } else {
          Write-Error "Driver not found!"
          exit 1
        }
    
    - name: Upload driver artifact
      uses: actions/upload-artifact@v4
      with:
        name: example-rawmouse-driver
        path: examples/rawmouse/bin/rawmouse.sys
        retention-days: 7

  #---------------------------------------------------------------------------
  # Template validation - Verify template structure (not compilation)
  # Templates contain placeholders like {{PROJECT_NAME}} and need processing
  #---------------------------------------------------------------------------
  test-templates:
    runs-on: windows-latest
    name: Validate Templates
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Validate template structure
      shell: pwsh
      run: |
        $templates = @("console", "gui", "dll", "driver", "shellcode")
        $required = @("main.asm", "build.bat", "project.json")
        $errors = 0
        
        foreach ($t in $templates) {
          $path = "templates/$t"
          if (-not (Test-Path $path)) {
            Write-Host "::warning::Template '$t' not found"
            continue
          }
          
          Write-Host "Validating template: $t"
          
          # Check for required files (main.asm or template-specific main)
          $hasMain = (Test-Path "$path/main.asm") -or ($t -eq "driver" -and (Test-Path "$path/driver.asm")) -or ($t -eq "dll" -and (Test-Path "$path/main.asm"))
          if (-not $hasMain) {
            Write-Host "::error::Template '$t' missing main assembly file"
            $errors++
          }
          
          if (-not (Test-Path "$path/build.bat")) {
            Write-Host "::error::Template '$t' missing build.bat"
            $errors++
          }
          
          if (-not (Test-Path "$path/project.json")) {
            Write-Host "::error::Template '$t' missing project.json"
            $errors++
          }
          
          Write-Host "  OK"
        }
        
        if ($errors -gt 0) {
          exit 1
        }
        Write-Host "All templates validated successfully"

  #---------------------------------------------------------------------------
  # Framework core tests
  #---------------------------------------------------------------------------
  test-framework:
    runs-on: windows-latest
    name: Framework Tests
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Visual Studio Build Tools
      uses: microsoft/setup-msbuild@v2
    
    - name: Build and run tests
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        
        if exist tests\hello\build.bat (
          cd tests\hello
          call build.bat
          cd ..\..
        )
        
        if exist tests\framework\build.bat (
          cd tests\framework
          call build.bat
          if exist bin\run-tests.exe (
            bin\run-tests.exe
          )
          cd ..\..
        )

  #---------------------------------------------------------------------------
  # Build summary
  #---------------------------------------------------------------------------
  summary:
    runs-on: ubuntu-latest
    name: Build Summary
    needs: [build-usermode, build-driver, test-templates, test-framework]
    if: always()
    
    steps:
    - name: Summary
      run: |
        echo "## Build Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Usermode Examples | ${{ needs.build-usermode.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Driver Example | ${{ needs.build-driver.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Template Tests | ${{ needs.test-templates.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Framework Tests | ${{ needs.test-framework.result }} |" >> $GITHUB_STEP_SUMMARY
