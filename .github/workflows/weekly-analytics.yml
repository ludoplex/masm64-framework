# Weekly Analytics Report
# Sends repository analytics via email every Monday at 9 AM UTC

name: Weekly Analytics Report

on:
  schedule:
    # Every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual trigger

jobs:
  send-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Get repository statistics
      id: stats
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -e
        
        # Get current date
        printf "report_date=%s\n" "$(date '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_OUTPUT
        
        # Get repo info
        REPO_INFO=$(gh api repos/${{ github.repository }})
        printf "stars=%s\n" "$(echo "$REPO_INFO" | jq -r '.stargazers_count // 0')" >> $GITHUB_OUTPUT
        printf "forks=%s\n" "$(echo "$REPO_INFO" | jq -r '.forks_count // 0')" >> $GITHUB_OUTPUT
        printf "watchers=%s\n" "$(echo "$REPO_INFO" | jq -r '.subscribers_count // 0')" >> $GITHUB_OUTPUT
        printf "open_issues=%s\n" "$(echo "$REPO_INFO" | jq -r '.open_issues_count // 0')" >> $GITHUB_OUTPUT
        
        # Get traffic data with fallbacks
        VIEWS_COUNT="0"
        VIEWS_UNIQUE="0"
        CLONES_COUNT="0"
        CLONES_UNIQUE="0"
        
        if VIEWS=$(gh api repos/${{ github.repository }}/traffic/views 2>/dev/null); then
          VIEWS_COUNT=$(echo "$VIEWS" | jq -r '.count // 0')
          VIEWS_UNIQUE=$(echo "$VIEWS" | jq -r '.uniques // 0')
        fi
        
        if CLONES=$(gh api repos/${{ github.repository }}/traffic/clones 2>/dev/null); then
          CLONES_COUNT=$(echo "$CLONES" | jq -r '.count // 0')
          CLONES_UNIQUE=$(echo "$CLONES" | jq -r '.uniques // 0')
        fi
        
        printf "views_count=%s\n" "$VIEWS_COUNT" >> $GITHUB_OUTPUT
        printf "views_unique=%s\n" "$VIEWS_UNIQUE" >> $GITHUB_OUTPUT
        printf "clones_count=%s\n" "$CLONES_COUNT" >> $GITHUB_OUTPUT
        printf "clones_unique=%s\n" "$CLONES_UNIQUE" >> $GITHUB_OUTPUT
        
        # Get top referrers
        TOP_REFERRERS="No data yet"
        if REFERRERS=$(gh api repos/${{ github.repository }}/traffic/popular/referrers 2>/dev/null); then
          PARSED=$(echo "$REFERRERS" | jq -r 'if length > 0 then .[0:5] | map("\(.referrer): \(.count)") | join(", ") else "No data yet" end')
          if [ -n "$PARSED" ]; then
            TOP_REFERRERS="$PARSED"
          fi
        fi
        printf "top_referrers=%s\n" "$TOP_REFERRERS" >> $GITHUB_OUTPUT
        
        # Get recent activity (last 7 days)
        WEEK_AGO=$(date -d '7 days ago' '+%Y-%m-%dT%H:%M:%SZ')
        
        COMMITS=$(gh api "repos/${{ github.repository }}/commits?since=$WEEK_AGO" --jq 'length' 2>/dev/null || echo "0")
        printf "commits_week=%s\n" "$COMMITS" >> $GITHUB_OUTPUT
        
        ISSUES_WEEK=$(gh api "repos/${{ github.repository }}/issues?state=all&since=$WEEK_AGO" --jq '[.[] | select(.pull_request == null)] | length' 2>/dev/null || echo "0")
        printf "issues_week=%s\n" "$ISSUES_WEEK" >> $GITHUB_OUTPUT
        
        PRS_WEEK=$(gh api "repos/${{ github.repository }}/pulls?state=all" --jq 'length' 2>/dev/null || echo "0")
        printf "prs_week=%s\n" "$PRS_WEEK" >> $GITHUB_OUTPUT
    
    - name: Generate and send report
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "MASM64 Framework Weekly Report - ${{ steps.stats.outputs.report_date }}"
        to: vincentlanderson@mightyhouseinc.com
        cc: rachelwilliams@mightyhouseinc.com
        from: "MASM64 Analytics <${{ secrets.SMTP_USERNAME }}>"
        priority: normal
        html_body: |
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f6f8fa; padding: 20px; margin: 0; }
              .container { max-width: 600px; margin: 0 auto; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
              .header { background: linear-gradient(135deg, #00d9ff, #7b61ff); color: #fff; padding: 30px; text-align: center; }
              .header h1 { margin: 0; font-size: 24px; }
              .header p { margin: 10px 0 0; opacity: 0.9; }
              .content { padding: 30px; }
              .stat-grid { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 30px; }
              .stat-box { flex: 1; min-width: 120px; background: #f6f8fa; border-radius: 8px; padding: 20px; text-align: center; }
              .stat-value { font-size: 28px; font-weight: bold; color: #0969da; }
              .stat-label { color: #656d76; font-size: 12px; margin-top: 5px; }
              .section { margin-bottom: 25px; }
              .section h3 { color: #1f2328; border-bottom: 1px solid #d0d7de; padding-bottom: 10px; margin-bottom: 15px; }
              .section ul { padding-left: 20px; color: #656d76; margin: 0; }
              .section li { margin-bottom: 8px; }
              .footer { background: #f6f8fa; padding: 20px; text-align: center; color: #656d76; font-size: 12px; }
              a { color: #0969da; text-decoration: none; }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <h1>MASM64 Framework</h1>
                <p>Weekly Analytics Report</p>
              </div>
              <div class="content">
                <p style="color: #656d76; margin-bottom: 20px;">Report: ${{ steps.stats.outputs.report_date }}</p>
                
                <div class="stat-grid">
                  <div class="stat-box">
                    <div class="stat-value">${{ steps.stats.outputs.views_count }}</div>
                    <div class="stat-label">Page Views</div>
                  </div>
                  <div class="stat-box">
                    <div class="stat-value">${{ steps.stats.outputs.views_unique }}</div>
                    <div class="stat-label">Unique Visitors</div>
                  </div>
                  <div class="stat-box">
                    <div class="stat-value">${{ steps.stats.outputs.clones_count }}</div>
                    <div class="stat-label">Clones</div>
                  </div>
                  <div class="stat-box">
                    <div class="stat-value">${{ steps.stats.outputs.clones_unique }}</div>
                    <div class="stat-label">Unique Cloners</div>
                  </div>
                </div>
                
                <div class="section">
                  <h3>Repository Stats</h3>
                  <ul>
                    <li><strong>Stars:</strong> ${{ steps.stats.outputs.stars }}</li>
                    <li><strong>Forks:</strong> ${{ steps.stats.outputs.forks }}</li>
                    <li><strong>Watchers:</strong> ${{ steps.stats.outputs.watchers }}</li>
                    <li><strong>Open Issues:</strong> ${{ steps.stats.outputs.open_issues }}</li>
                  </ul>
                </div>
                
                <div class="section">
                  <h3>This Week's Activity</h3>
                  <ul>
                    <li><strong>Commits:</strong> ${{ steps.stats.outputs.commits_week }}</li>
                    <li><strong>Issues:</strong> ${{ steps.stats.outputs.issues_week }}</li>
                    <li><strong>Pull Requests:</strong> ${{ steps.stats.outputs.prs_week }}</li>
                  </ul>
                </div>
                
                <div class="section">
                  <h3>Top Referrers</h3>
                  <p style="background: #f6f8fa; padding: 15px; border-radius: 6px; margin: 0;">${{ steps.stats.outputs.top_referrers }}</p>
                </div>
                
                <p style="text-align: center; margin-top: 30px;">
                  <a href="https://github.com/${{ github.repository }}">View Repository</a> | 
                  <a href="https://github.com/${{ github.repository }}/graphs/traffic">Traffic Dashboard</a>
                </p>
              </div>
              <div class="footer">
                <p>MASM64 Framework - Weekly Analytics<br>
                <a href="https://ludoplex.github.io/masm64-framework/">ludoplex.github.io/masm64-framework</a></p>
              </div>
            </div>
          </body>
          </html>
