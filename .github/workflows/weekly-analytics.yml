# Weekly Analytics Report
# Sends repository analytics via email every Monday at 9 AM UTC

name: Weekly Analytics Report

on:
  schedule:
    # Every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual trigger

jobs:
  send-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Get repository statistics
      id: stats
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Get current date
        REPORT_DATE=$(date '+%Y-%m-%d %H:%M UTC')
        echo "report_date=$REPORT_DATE" >> $GITHUB_OUTPUT
        
        # Get repo info
        REPO_INFO=$(gh api repos/${{ github.repository }})
        STARS=$(echo "$REPO_INFO" | jq -r '.stargazers_count')
        FORKS=$(echo "$REPO_INFO" | jq -r '.forks_count')
        WATCHERS=$(echo "$REPO_INFO" | jq -r '.subscribers_count')
        OPEN_ISSUES=$(echo "$REPO_INFO" | jq -r '.open_issues_count')
        
        echo "stars=$STARS" >> $GITHUB_OUTPUT
        echo "forks=$FORKS" >> $GITHUB_OUTPUT
        echo "watchers=$WATCHERS" >> $GITHUB_OUTPUT
        echo "open_issues=$OPEN_ISSUES" >> $GITHUB_OUTPUT
        
        # Get traffic data (views and clones)
        VIEWS=$(gh api repos/${{ github.repository }}/traffic/views 2>/dev/null || echo '{"count":0,"uniques":0}')
        VIEWS_COUNT=$(echo "$VIEWS" | jq -r '.count // 0')
        VIEWS_UNIQUE=$(echo "$VIEWS" | jq -r '.uniques // 0')
        
        CLONES=$(gh api repos/${{ github.repository }}/traffic/clones 2>/dev/null || echo '{"count":0,"uniques":0}')
        CLONES_COUNT=$(echo "$CLONES" | jq -r '.count // 0')
        CLONES_UNIQUE=$(echo "$CLONES" | jq -r '.uniques // 0')
        
        echo "views_count=$VIEWS_COUNT" >> $GITHUB_OUTPUT
        echo "views_unique=$VIEWS_UNIQUE" >> $GITHUB_OUTPUT
        echo "clones_count=$CLONES_COUNT" >> $GITHUB_OUTPUT
        echo "clones_unique=$CLONES_UNIQUE" >> $GITHUB_OUTPUT
        
        # Get top referrers (as single line, comma-separated)
        REFERRERS=$(gh api repos/${{ github.repository }}/traffic/popular/referrers 2>/dev/null || echo '[]')
        TOP_REFERRERS=$(echo "$REFERRERS" | jq -r '.[0:5] | map("\(.referrer): \(.count)") | join(", ")' 2>/dev/null || echo "No data")
        if [ -z "$TOP_REFERRERS" ]; then TOP_REFERRERS="No referrer data"; fi
        echo "top_referrers=$TOP_REFERRERS" >> $GITHUB_OUTPUT
        
        # Get recent commits count (last 7 days)
        WEEK_AGO=$(date -d '7 days ago' '+%Y-%m-%dT%H:%M:%SZ')
        COMMITS=$(gh api "repos/${{ github.repository }}/commits?since=$WEEK_AGO" --jq 'length')
        echo "commits_week=$COMMITS" >> $GITHUB_OUTPUT
        
        # Get recent issues/PRs
        ISSUES_WEEK=$(gh api "repos/${{ github.repository }}/issues?state=all&since=$WEEK_AGO" --jq '[.[] | select(.pull_request == null)] | length')
        PRS_WEEK=$(gh api "repos/${{ github.repository }}/pulls?state=all" --jq "[.[] | select(.created_at >= \"$WEEK_AGO\")] | length")
        echo "issues_week=$ISSUES_WEEK" >> $GITHUB_OUTPUT
        echo "prs_week=$PRS_WEEK" >> $GITHUB_OUTPUT
    
    - name: Generate report content
      id: report
      run: |
        cat << 'REPORT_EOF' > report.html
        <!DOCTYPE html>
        <html>
        <head>
          <style>
            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f6f8fa; padding: 20px; }
            .container { max-width: 600px; margin: 0 auto; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
            .header { background: linear-gradient(135deg, #00d9ff, #7b61ff); color: #fff; padding: 30px; text-align: center; }
            .header h1 { margin: 0; font-size: 24px; }
            .header p { margin: 10px 0 0; opacity: 0.9; }
            .content { padding: 30px; }
            .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
            .stat-box { background: #f6f8fa; border-radius: 8px; padding: 20px; text-align: center; }
            .stat-value { font-size: 32px; font-weight: bold; color: #0969da; }
            .stat-label { color: #656d76; font-size: 14px; margin-top: 5px; }
            .section { margin-bottom: 25px; }
            .section h3 { color: #1f2328; border-bottom: 1px solid #d0d7de; padding-bottom: 10px; }
            .section ul { padding-left: 20px; color: #656d76; }
            .footer { background: #f6f8fa; padding: 20px; text-align: center; color: #656d76; font-size: 12px; }
            a { color: #0969da; }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <h1>MASM64 Framework</h1>
              <p>Weekly Analytics Report</p>
            </div>
            <div class="content">
              <p style="color: #656d76; margin-bottom: 20px;">Report generated: ${{ steps.stats.outputs.report_date }}</p>
              
              <div class="stat-grid">
                <div class="stat-box">
                  <div class="stat-value">${{ steps.stats.outputs.views_count }}</div>
                  <div class="stat-label">Page Views (14 days)</div>
                </div>
                <div class="stat-box">
                  <div class="stat-value">${{ steps.stats.outputs.views_unique }}</div>
                  <div class="stat-label">Unique Visitors</div>
                </div>
                <div class="stat-box">
                  <div class="stat-value">${{ steps.stats.outputs.clones_count }}</div>
                  <div class="stat-label">Git Clones</div>
                </div>
                <div class="stat-box">
                  <div class="stat-value">${{ steps.stats.outputs.clones_unique }}</div>
                  <div class="stat-label">Unique Cloners</div>
                </div>
              </div>
              
              <div class="section">
                <h3>Repository Stats</h3>
                <ul>
                  <li>Stars: ${{ steps.stats.outputs.stars }}</li>
                  <li>Forks: ${{ steps.stats.outputs.forks }}</li>
                  <li>Watchers: ${{ steps.stats.outputs.watchers }}</li>
                  <li>Open Issues: ${{ steps.stats.outputs.open_issues }}</li>
                </ul>
              </div>
              
              <div class="section">
                <h3>This Week's Activity</h3>
                <ul>
                  <li>Commits: ${{ steps.stats.outputs.commits_week }}</li>
                  <li>New Issues: ${{ steps.stats.outputs.issues_week }}</li>
                  <li>Pull Requests: ${{ steps.stats.outputs.prs_week }}</li>
                </ul>
              </div>
              
              <div class="section">
                <h3>Top Referrers</h3>
                <p style="background: #f6f8fa; padding: 15px; border-radius: 6px;">${{ steps.stats.outputs.top_referrers }}</p>
              </div>
              
              <p style="text-align: center; margin-top: 30px;">
                <a href="https://github.com/${{ github.repository }}">View Repository</a> |
                <a href="https://github.com/${{ github.repository }}/graphs/traffic">Full Traffic Data</a>
              </p>
            </div>
            <div class="footer">
              <p>MASM64 Framework - Weekly Analytics Report<br>
              <a href="https://ludoplex.github.io/masm64-framework/">ludoplex.github.io/masm64-framework</a></p>
            </div>
          </div>
        </body>
        </html>
        REPORT_EOF
        
        echo "Report generated successfully"
    
    - name: Send email report
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "MASM64 Framework Weekly Report - ${{ steps.stats.outputs.report_date }}"
        to: vincentlanderson@mightyhouseinc.com
        cc: rachelwilliams@mightyhouseinc.com
        from: "MASM64 Analytics <${{ secrets.SMTP_USERNAME }}>"
        html_body: file://report.html
        priority: normal

