# MASM64 Framework Release Workflow
# Automatically creates releases when version tags are pushed

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string

env:
  UASM_VERSION: "2.56.2"

jobs:
  build-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
    
    - name: Setup Visual Studio Build Tools
      uses: microsoft/setup-msbuild@v2
    
    - name: Download UASM
      shell: pwsh
      run: |
        $uasmUrl = "https://github.com/AsmProjects/uasm/releases/download/v${{ env.UASM_VERSION }}/uasm-${{ env.UASM_VERSION }}-windows-x64.zip"
        Invoke-WebRequest -Uri $uasmUrl -OutFile uasm.zip -ErrorAction SilentlyContinue
        if (Test-Path uasm.zip) {
            Expand-Archive -Path uasm.zip -DestinationPath tools\uasm
        }
    
    - name: Build all templates
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        
        cd templates\console
        call build.bat
        cd ..\..
        
        cd templates\gui
        call build.bat
        cd ..\..
        
        cd templates\dll
        call build.bat
        cd ..\..
    
    - name: Build tests
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        cd tests\hello
        call build.bat
        cd ..\..
        cd tests\framework
        call build.bat
    
    - name: Run tests
      shell: cmd
      run: |
        cd tests\framework
        bin\run-tests.exe
        if %ERRORLEVEL% NEQ 0 exit /b 1
    
    - name: Create release package
      shell: pwsh
      run: |
        $version = if ("${{ github.event.inputs.version }}") { "${{ github.event.inputs.version }}" } else { "${{ github.ref_name }}" }
        
        # Create release directory
        New-Item -ItemType Directory -Path release -Force
        
        # Copy core files
        Copy-Item -Path core -Destination release\core -Recurse
        Copy-Item -Path lib -Destination release\lib -Recurse
        Copy-Item -Path templates -Destination release\templates -Recurse
        Copy-Item -Path tools -Destination release\tools -Recurse
        Copy-Item -Path docs -Destination release\docs -Recurse
        Copy-Item -Path README.md -Destination release\
        Copy-Item -Path LICENSE -Destination release\
        Copy-Item -Path CONTRIBUTING.md -Destination release\
        
        # Create zip archive
        Compress-Archive -Path release\* -DestinationPath "masm64-framework-$version.zip"
        
        # Create hash file
        $hash = Get-FileHash "masm64-framework-$version.zip" -Algorithm SHA256
        "$($hash.Hash)  masm64-framework-$version.zip" | Out-File -FilePath "masm64-framework-$version.zip.sha256"
    
    - name: Generate changelog
      id: changelog
      shell: pwsh
      run: |
        $version = if ("${{ github.event.inputs.version }}") { "${{ github.event.inputs.version }}" } else { "${{ github.ref_name }}" }
        
        # Get commits since last tag
        $lastTag = git describe --tags --abbrev=0 HEAD^ 2>$null
        if ($lastTag) {
            $commits = git log "$lastTag..HEAD" --pretty=format:"- %s" --no-merges
        } else {
            $commits = git log --pretty=format:"- %s" --no-merges -20
        }
        
        $changelog = @"
        ## What's Changed
        
        $commits
        
        ## Installation
        
        1. Download ``masm64-framework-$version.zip``
        2. Extract to your development directory
        3. See ``docs/QUICKSTART.md`` for getting started
        
        ## Requirements
        
        - Windows 10/11 x64
        - UASM or ML64 assembler
        - Windows SDK
        - Visual Studio Build Tools (optional)
        "@
        
        $changelog | Out-File -FilePath changelog.md
        "changelog_file=changelog.md" >> $env:GITHUB_OUTPUT
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        body_path: changelog.md
        files: |
          masm64-framework-*.zip
          masm64-framework-*.sha256
        draft: false
        prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    runs-on: ubuntu-latest
    needs: build-release
    if: success()
    
    steps:
    - name: Release notification
      run: |
        echo "Release ${{ github.ref_name }} has been published!"
        echo "View at: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"

